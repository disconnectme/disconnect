/* Copyright 2011 WebMynd Corp. All rights reserved. */
(function(c,b,d){var a="2b74ff14-7256-42e0-9bf1-0806eec78788";var c=c||window;var b=b||document;background_window=window;window=c;window.webmynd=window.webmynd||{};window.webmynd[a]=window.webmynd[a]||{};window.webmynd[a].services={port_listeners:[],contentScript:{port_listeners:[]},responses:[],console:{consoleService:Components.classes["@mozilla.org/consoleservice;1"].getService(Components.interfaces.nsIConsoleService),log:function(e){window.webmynd[a].services.console.consoleService.logStringMessage(e)}},prefs:Components.classes["@mozilla.org/preferences-service;1"].getService(Components.interfaces.nsIPrefService),_myPrefs:Components.classes["@mozilla.org/preferences-service;1"].getService(Components.interfaces.nsIPrefService).getBranch("extensions."+a+"."),newXHR:function(){return Components.classes["@mozilla.org/xmlextras/xmlhttprequest;1"].createInstance()},getLocalPref:function(i,j,k){var h=window.webmynd[a].services._myPrefs,f=null,g=null;try{g=h.getCharPref(i)}catch(l){window.webmynd[a].services.console.log("No such local preference: "+i);return k(f)}f=JSON.parse(decodeURIComponent(g));k(f)},setLocalPref:function(f,g,h){var e=window.webmynd[a].services._myPrefs;e.setCharPref(f,encodeURIComponent(JSON.stringify(h)))},getLocalKeys:function(g){var e=window.webmynd[a].services._myPrefs,f=e.getChildList("",{});g&&g(f);return f},clearLocalKey:function(g){var f=window.webmynd[a].services._myPrefs;try{f.clearUserPref(g)}catch(h){}},backgroundOpenUrl:function(f){var e=Components.classes["@mozilla.org/appshell/window-mediator;1"].getService(Components.interfaces.nsIWindowMediator).getMostRecentWindow("navigator:browser");e.gBrowser.selectedTab=e.gBrowser.addTab(f)},readFile:function(g){var i="";var e=Components.classes["@mozilla.org/network/file-input-stream;1"].createInstance(Components.interfaces.nsIFileInputStream);var f=Components.classes["@mozilla.org/intl/converter-input-stream;1"].createInstance(Components.interfaces.nsIConverterInputStream);e.init(g,-1,0,0);f.init(e,"UTF-8",0,0);var j={},h=0;do{h=f.readString(4294967295,j);i+=j.value}while(h!=0);f.close();return i},insertScriptsOnce:function(k,f,j){oldscripts=k.getElementsByTagName("head")[0].getElementsByTagName("script");var e=oldscripts.length;var h;for(var g=0;g<e;g++){h=oldscripts[e-g-1];h.getAttribute("class")==("wmScripts "+a)&&k.getElementsByTagName("head")[0].removeChild(h)}var l=function(m){var i=k.createElement("script");i.setAttribute("type","text/javascript");i.setAttribute("class","wmScripts "+a);i.innerHTML=window.webmynd[a].services.readFile(m);k.getElementsByTagName("head")[0].appendChild(i)};if(Components.classes["@mozilla.org/extensions/manager;1"]){setTimeout(function(){var o=Components.classes["@mozilla.org/extensions/manager;1"].getService(Components.interfaces.nsIExtensionManager);for(var n=0;n<f.length;n++){var m=o.getInstallLocation("disconnect@disconnect.me").getItemFile("disconnect@disconnect.me","content/"+f[n]);l(m)}},25)}else{Components.utils["import"]("resource://gre/modules/AddonManager.jsm");AddonManager.getAddonByID("disconnect@disconnect.me",function(i){setTimeout(function(){for(var n=0;n<f.length;n++){var m=i.getResourceURI("content/"+f[n]).QueryInterface(Components.interfaces.nsIFileURL).file;l(m)}},25)})}},getOldUsername:function(){var f=Components.classes["@mozilla.org/file/directory_service;1"].getService(Components.interfaces.nsIProperties).get("ProfD",Components.interfaces.nsIFile);f.append("credentials");var e=window.webmynd[a].services.readFile(f);return(e&&e.split(",")[0])||false},sendRequestToTabs:function(k,m){function f(n,o){for(var i=0;i<n.webmynd[a].services.onRequest.listeners.length;i++){n.webmynd[a].services.onRequest.listeners[i](o)}}var l=Components.classes["@mozilla.org/appshell/window-mediator;1"].getService(Components.interfaces.nsIWindowMediator).getEnumerator(null);while(l.hasMoreElements()){var j=l.getNext();if(!j.webmynd||!j.webmynd[a]){continue}if(k.port&&j.webmynd[a].contentScript&&j.webmynd[a].contentScript.webmynd&&j.webmynd[a].contentScript.webmynd[a]&&j.webmynd[a].contentScript.webmynd[a].services.port_listeners[k.port]){var g=j.webmynd[a].contentScript.webmynd[a].services.port_listeners;for(var e=0;e<g[k.port].length;e++){g[k.port][e](k.body)}}for(var e=0;e<j.gBrowser.browsers.length;e++){var h=j.gBrowser.browsers[e].contentWindow;if(h.webmynd&&h.webmynd[a]){f(h,k)}}}},sendRequestToFocussedTab:function(j,k){var h=Components.classes["@mozilla.org/appshell/window-mediator;1"].getService(Components.interfaces.nsIWindowMediator).getMostRecentWindow(null);if(!h.webmynd||!h.webmynd[a]){window.webmynd[a].services.console.log("WebMynd platform not attached to current window");return}var e=h.gBrowser.selectedBrowser,g=e.contentWindow;if(g.webmynd&&g.webmynd[a]){for(var f=0;f<g.webmynd[a].services.onRequest.listeners.length;f++){g.webmynd[a].services.onRequest.listeners[f](j)}}},sendRequest:function(g,e){for(var f=0;f<background_window.webmynd[a].services.onRequest.listeners.length;f++){background_window.webmynd[a].services.onRequest.listeners[f](g,null,e)}},onRequest:{listeners:[],addListener:function(e){window.webmynd[a].services.onRequest.listeners.push(e)}},connect:function(e){function j(k,l){var i=this;i.name=k;i.fgToBg=l;i.sibling=null;i.listeners=[];i.onMessage={addListener:function(m){i.listeners.push(m)}};i.postMessage=function(m){i.sibling._postMessageImpl(m)};i._postMessageImpl=function(m){i.listeners.forEach(function(n){n(m)})}}var h=new j(e.name,true),g=new j(e.name,false);h.sibling=g;g.sibling=h;if(d){for(var f=0;f<background_window.webmynd[a].services.onConnect.listeners.length;f++){background_window.webmynd[a].services.onConnect.listeners[f](g)}}else{for(var f=0;f<window.webmynd[a].services.onConnect.listeners.length;f++){window.webmynd[a].services.onConnect.listeners[f](h)}}return(d?h:g)},onConnect:{listeners:[],addListener:function(e){window.webmynd[a].services.onConnect.listeners.push(e)}},getURL:function(e){if(e.slice(0,1)=="/"){return("resource://"+a+e)}else{return("resource://"+a+"/"+e)}},button:{setIcon:function(e){document.getElementById(a+"-image").setAttribute("src",e.url)},setUrl:function(e){},onClicked:{listeners:[],addListener:function(e){window.webmynd[a].services.button.onClicked.listeners.push(e)}},click:function(){for(var e=0;e<window.webmynd[a].services.button.onClicked.listeners.length;e++){window.webmynd[a].services.button.onClicked.listeners[e]()}}},beforeLoad:function(e){e(evt)}}})(win,doc,inPageScript);